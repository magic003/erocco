<!DOCTYPE html>
<html>
<head>
  <title>erocco.erl</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="erocco.css"/>
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
<div id="jump_to">
  Jump To &hellip;
  <div id="jump_wrapper">
  <div id="jump_page">
  <a class="source" href="erocco_main.html">erocco_main.erl</a>
  <a class="source" href="index.html">erocco.erl</a>
    </div>
  </div>
</div>
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>
              erocco.erl
            </h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
<tr id="section-1">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-1">&#182;</a>
  </div>
  <p><strong>Erocco</strong> is a quick-and-dirty, hundred-line-long, literate-programming-
style documentation generator. It produces HTML that displays your comments
alongside your code. Comments are passed through
<a href="http://daringfireball.net/projects/markdown/syntax">Markdown</a>, and code is
passed through <a href="http://pygments.org/">Pygments</a> syntax highlighting.
This page is the result of running Erocco against its own source file.</p>

<p>If you install Erocco, you can run it from the command-line:</p>
<pre><code>erocco src/*.erl 
</code></pre>

<p>...will generate an HTML documentation page for each of the named source 
files, with a menu linking to other pages, saving it into a <code>docs</code> folder.</p>

<p>The <a href="http://github.com/magic003/erocco">source for Erocco</a> is available on
GitHub, and released under the MIT license.</p>

<p>For its syntax highlighting Erocco relies on 
<a href="http://pyments.org/">Pygments</a>. It is called either through a local 
installation or remote <a href="http://pygments.appspot.com">web service</a>. As a 
markdown engine it ships with Gordon Guthrie's 
<a href="http://github.com/gordonguthrie/erlmarkdown">erlmarkdown</a>. Otherwise there
are no external dependencies.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">erocco</span><span class="p">).</span>
<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">generate_documentation</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span></pre></div>
</td>
</tr>
<tr id="section-2">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-2">&#182;</a>
  </div>
  <h3>Record &amp; Macros</h3>
</td>
<td class="code">
  <div class="highlight"><pre></pre></div>
</td>
</tr>
<tr id="section-3">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-3">&#182;</a>
  </div>
  <p>Programming language record.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">record</span><span class="p">(</span><span class="nl">lang</span><span class="p">,</span>
    <span class="p">{</span><span class="n">extension</span><span class="p">,</span>
     <span class="n">name</span><span class="p">,</span>
     <span class="n">symbol</span><span class="p">,</span>
     <span class="n">comment_matcher</span><span class="p">,</span> <span class="n">comment_filter</span><span class="p">,</span>
     <span class="n">divider_text</span><span class="p">,</span> <span class="n">divider_html</span><span class="p">}).</span></pre></div>
</td>
</tr>
<tr id="section-4">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-4">&#182;</a>
  </div>
  <p>Supported languages.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">LANGS</span><span class="p">,[</span>
        <span class="nl">#lang</span><span class="p">{</span><span class="n">extension</span><span class="o">=</span><span class="s">&quot;.coffee&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;coffee-script&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">},</span>
        <span class="nl">#lang</span><span class="p">{</span><span class="n">extension</span><span class="o">=</span><span class="s">&quot;.js&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;javascript&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="s">&quot;//&quot;</span><span class="p">},</span>
        <span class="nl">#lang</span><span class="p">{</span><span class="n">extension</span><span class="o">=</span><span class="s">&quot;.rb&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;ruby&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">},</span>
        <span class="nl">#lang</span><span class="p">{</span><span class="n">extension</span><span class="o">=</span><span class="s">&quot;.py&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;python&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="s">&quot;#&quot;</span><span class="p">},</span>
        <span class="nl">#lang</span><span class="p">{</span><span class="n">extension</span><span class="o">=</span><span class="s">&quot;.erl&quot;</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;erlang&quot;</span><span class="p">,</span><span class="n">symbol</span><span class="o">=</span><span class="s">&quot;%&quot;</span><span class="p">}]).</span></pre></div>
</td>
</tr>
<tr id="section-5">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-5">&#182;</a>
  </div>
  <p>Pygments executable name.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">PYGMENTIZE</span><span class="p">,</span><span class="s">&quot;pygmentize&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-6">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-6">&#182;</a>
  </div>
  <p>Pygments web service URL.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">PYGMENTIZE_URL</span><span class="p">,</span><span class="s">&quot;http://pygments.appspot.com&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-7">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-7">&#182;</a>
  </div>
  <p>The start of each Pygments highlight block.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">HIGHLIGHT_START</span><span class="p">,</span><span class="s">&quot;&lt;div class=</span><span class="se">\&quot;</span><span class="s">highlight</span><span class="se">\&quot;</span><span class="s">&gt;&lt;pre&gt;&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-8">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-8">&#182;</a>
  </div>
  <p>The end of each Pygments highlight block.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">HIGHLIGHT_END</span><span class="p">,</span><span class="s">&quot;&lt;/pre&gt;&lt;/div&gt;&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-9">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-9">&#182;</a>
  </div>
  <p>The output html templates.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">HEADER</span><span class="p">,</span><span class="s">&quot;&lt;!DOCTYPE html&gt;</span>
<span class="s">&lt;html&gt;</span>
<span class="s">&lt;head&gt;</span>
<span class="s">  &lt;title&gt;?title&lt;/title&gt;</span>
<span class="s">  &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s">content-type</span><span class="se">\&quot;</span><span class="s"> content=</span><span class="se">\&quot;</span><span class="s">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">  &lt;link rel=</span><span class="se">\&quot;</span><span class="s">stylesheet</span><span class="se">\&quot;</span><span class="s"> media=</span><span class="se">\&quot;</span><span class="s">all</span><span class="se">\&quot;</span><span class="s"> href=</span><span class="se">\&quot;</span><span class="s">erocco.css</span><span class="se">\&quot;</span><span class="s">/&gt;</span>
<span class="s">&lt;/head&gt;</span>
<span class="s">&lt;body&gt;</span>
<span class="s">  &lt;div id=</span><span class="se">\&quot;</span><span class="s">container</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">    &lt;div id=</span><span class="se">\&quot;</span><span class="s">background</span><span class="se">\&quot;</span><span class="s">&gt;&lt;/div&gt;</span>
<span class="s">    ?jump</span>
<span class="s">    &lt;table cellpadding=</span><span class="se">\&quot;</span><span class="s">0</span><span class="se">\&quot;</span><span class="s"> cellspacing=</span><span class="se">\&quot;</span><span class="s">0</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">      &lt;thead&gt;</span>
<span class="s">        &lt;tr&gt;</span>
<span class="s">          &lt;th class=</span><span class="se">\&quot;</span><span class="s">docs</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">            &lt;h1&gt;</span>
<span class="s">              ?title</span>
<span class="s">            &lt;/h1&gt;</span>
<span class="s">          &lt;/th&gt;</span>
<span class="s">          &lt;th class=</span><span class="se">\&quot;</span><span class="s">code</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">          &lt;/th&gt;</span>
<span class="s">        &lt;/tr&gt;</span>
<span class="s">      &lt;/thead&gt;</span>
<span class="s">      &lt;tbody&gt;&quot;</span><span class="p">).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JUMP_START</span><span class="p">,</span><span class="s">&quot;</span>
<span class="s">&lt;div id=</span><span class="se">\&quot;</span><span class="s">jump_to</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">  Jump To </span><span class="se">\\</span><span class="s">&amp;hellip;</span>
<span class="s">  &lt;div id=</span><span class="se">\&quot;</span><span class="s">jump_wrapper</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">  &lt;div id=</span><span class="se">\&quot;</span><span class="s">jump_page</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JUMP</span><span class="p">,</span><span class="s">&quot;</span>
<span class="s">  &lt;a class=</span><span class="se">\&quot;</span><span class="s">source</span><span class="se">\&quot;</span><span class="s"> href=</span><span class="se">\&quot;</span><span class="s">?jump_html</span><span class="se">\&quot;</span><span class="s">&gt;?jump_file&lt;/a&gt;&quot;</span><span class="p">).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">JUMP_END</span><span class="p">,</span><span class="s">&quot;</span>
<span class="s">    &lt;/div&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">&lt;/div&gt;&quot;</span><span class="p">).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">TABLE_ENTRY</span><span class="p">,</span><span class="s">&quot;</span>
<span class="s">&lt;tr id=</span><span class="se">\&quot;</span><span class="s">section-?index</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">&lt;td class=</span><span class="se">\&quot;</span><span class="s">docs</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">  &lt;div class=</span><span class="se">\&quot;</span><span class="s">pilwrap</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">    &lt;a class=</span><span class="se">\&quot;</span><span class="s">pilcrow</span><span class="se">\&quot;</span><span class="s"> href=</span><span class="se">\&quot;</span><span class="s">#section-?index</span><span class="se">\&quot;</span><span class="s">&gt;&amp;#182;&lt;/a&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">  ?docs_html</span>
<span class="s">&lt;/td&gt;</span>
<span class="s">&lt;td class=</span><span class="se">\&quot;</span><span class="s">code</span><span class="se">\&quot;</span><span class="s">&gt;</span>
<span class="s">  ?code_html</span>
<span class="s">&lt;/td&gt;</span>
<span class="s">&lt;/tr&gt;&quot;</span><span class="p">).</span>

<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">FOOTER</span><span class="p">,</span><span class="s">&quot;&lt;/tbody&gt;</span>
<span class="s">    &lt;/table&gt;</span>
<span class="s">  &lt;/div&gt;</span>
<span class="s">&lt;/body&gt;</span>
<span class="s">&lt;/html&gt;&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-10">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-10">&#182;</a>
  </div>
  <p>Placeholders for special characters.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">AMP</span><span class="p">,</span><span class="s">&quot;&&quot;</span><span class="p">).</span>
<span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">SLASH</span><span class="p">,</span> <span class="s">&quot;\&quot;</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-11">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-11">&#182;</a>
  </div>
  <p>Output directory.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="p">-</span><span class="ni">define</span><span class="p">(</span><span class="no">OUTDIR</span><span class="p">,</span><span class="s">&quot;docs/&quot;</span><span class="p">).</span>
 </pre></div>
</td>
</tr>
<tr id="section-12">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-12">&#182;</a>
  </div>
  <h3>Main Documentation Generation Functions</h3>
</td>
<td class="code">
  <div class="highlight"><pre></pre></div>
</td>
</tr>
<tr id="section-13">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-13">&#182;</a>
  </div>
  <p>Generate the documentation for source files specified using a Unix
wildcard style.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">generate_documentation</span><span class="p">(</span><span class="nv">Sources</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nv">Sources</span> <span class="k">of</span>
        <span class="p">[</span><span class="nv">H</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">generate_documentation</span><span class="p">([</span><span class="nv">H</span><span class="p">],</span><span class="s">&quot;&quot;</span><span class="p">);</span>
        <span class="p">[</span><span class="nv">H</span><span class="p">|</span><span class="nv">N</span><span class="p">]</span> <span class="o">-&gt;</span>
            <span class="nv">Jump</span> <span class="o">=</span> <span class="n">generate_jump</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">N</span><span class="p">],[],</span><span class="n">get_language</span><span class="p">(</span><span class="nv">H</span><span class="p">)),</span>
            <span class="n">generate_documentation</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">N</span><span class="p">],</span><span class="nv">Jump</span><span class="p">);</span>
        <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">ok</span>
    <span class="k">end</span><span class="p">.</span></pre></div>
</td>
</tr>
<tr id="section-14">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-14">&#182;</a>
  </div>
  <p>Generate the documentation for a source file by reading it in, splitting it
up into comment/code sections, highlighting them for appropriate languages,
and merging them into an HTML template.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">generate_documentation</span><span class="p">([],_)</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">;</span>
<span class="nf">generate_documentation</span><span class="p">([</span><span class="nv">Source</span><span class="p">|</span><span class="nv">Next</span><span class="p">],</span> <span class="nv">Jump</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Lang</span> <span class="o">=</span> <span class="n">get_language</span><span class="p">(</span><span class="nv">Source</span><span class="p">),</span>
    <span class="nv">Lines</span> <span class="o">=</span> <span class="n">read_source</span><span class="p">(</span><span class="nv">Source</span><span class="p">),</span>
    <span class="nv">Sections</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Lines</span><span class="p">),</span>
    <span class="nv">HighlightedSections</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Sections</span><span class="p">),</span>
    <span class="nv">File</span> <span class="o">=</span> <span class="n">generate_html</span><span class="p">(</span><span class="nv">Source</span><span class="p">,</span><span class="nv">HighlightedSections</span><span class="p">,</span><span class="nv">Jump</span><span class="p">),</span>
    <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;File </span><span class="si">~s</span><span class="s"> is generated.</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,[</span><span class="nv">File</span><span class="p">]),</span>
    <span class="n">generate_documentation</span><span class="p">(</span><span class="nv">Next</span><span class="p">,</span><span class="nv">Jump</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-15">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-15">&#182;</a>
  </div>
  <p>Given lines of source code, parse out each comment and the code that
follows it, and create an individual section for it. Sections take the form:</p>

<pre><code> {
   docs_text: ...,
   docs_html: ...,
   code_text: ...,
   code_html: ...
 }
</code></pre>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span> <span class="nv">Lines</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">lists</span><span class="p">:</span><span class="n">reverse</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span> <span class="nv">Lines</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])).</span>

<span class="nf">parse</span><span class="p">(_,</span> <span class="p">[],</span> <span class="nv">DocsText</span><span class="p">,</span> <span class="nv">CodeText</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">)</span> <span class="o">-&gt;</span> 
    <span class="n">save_section</span><span class="p">(</span><span class="nv">DocsText</span><span class="p">,</span> <span class="nv">CodeText</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">);</span>
<span class="nf">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span> <span class="p">[</span><span class="nv">L</span> <span class="p">|</span> <span class="nv">Next</span><span class="p">],</span> <span class="nv">DocsText</span><span class="p">,</span> <span class="nv">CodeText</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="p">{</span><span class="nn">re</span><span class="p">:</span><span class="n">run</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span><span class="nv">Lang</span><span class="nl">#lang.comment_matcher</span><span class="p">,[{</span><span class="n">capture</span><span class="p">,</span><span class="n">none</span><span class="p">}]),</span>
        <span class="nn">re</span><span class="p">:</span><span class="n">run</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span><span class="nv">Lang</span><span class="nl">#lang.comment_filter</span><span class="p">,[{</span><span class="n">capture</span><span class="p">,</span><span class="n">none</span><span class="p">}])}</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">match</span><span class="p">,</span><span class="n">nomatch</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nv">Doc</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">L</span><span class="p">,</span><span class="nv">Lang</span><span class="nl">#lang.comment_matcher</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,[{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
            <span class="k">case</span> <span class="nv">CodeText</span> <span class="k">of</span>
                <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Next</span><span class="p">,[</span><span class="nv">Doc</span> <span class="p">|</span> <span class="nv">DocsText</span><span class="p">],</span> <span class="nv">CodeText</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">);</span>
                <span class="p">_</span>  <span class="o">-&gt;</span> <span class="n">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Next</span><span class="p">,[</span><span class="nv">Doc</span><span class="p">],</span> <span class="p">[],</span><span class="n">save_section</span><span class="p">(</span><span class="nv">DocsText</span><span class="p">,</span><span class="nv">CodeText</span><span class="p">,</span><span class="nv">Sections</span><span class="p">))</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="p">_</span> <span class="o">-&gt;</span> <span class="n">parse</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Next</span><span class="p">,</span><span class="nv">DocsText</span><span class="p">,[</span><span class="nv">L</span><span class="p">|</span><span class="nv">CodeText</span><span class="p">],</span><span class="nv">Sections</span><span class="p">)</span>
    <span class="k">end</span><span class="p">.</span></pre></div>
</td>
</tr>
<tr id="section-16">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-16">&#182;</a>
  </div>
  <p>Loop through a table of split sections, pass the code through <strong>Pygments</strong>
and convert the document from <strong>Markdown</strong> to HTML. Add docs_html and 
code_html to the sections</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">highlight</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Code</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">join</span><span class="p">([</span><span class="nv">CodeText</span> <span class="p">||</span> <span class="p">{_,</span><span class="nv">CodeText</span><span class="p">}</span> <span class="o">&lt;-</span> <span class="nv">Sections</span><span class="p">],</span><span class="nv">Lang</span><span class="nl">#lang.divider_text</span><span class="p">),</span>
    <span class="nv">ParentID</span> <span class="o">=</span> <span class="n">self</span><span class="p">(),</span>
    <span class="nv">PygmentID</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pygmentize</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Code</span><span class="p">,</span><span class="nv">ParentID</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span> 
    <span class="nv">MarkdownID</span> <span class="o">=</span> <span class="nb">spawn</span><span class="p">(</span><span class="k">fun</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="nv">Sections</span><span class="p">,</span><span class="nv">ParentID</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
    <span class="k">receive</span> 
        <span class="p">{</span><span class="nv">PygmentID</span><span class="p">,</span> <span class="nv">CodeHtml</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">CodeHtml</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="k">receive</span>
        <span class="p">{</span><span class="nv">MarkdownID</span><span class="p">,</span> <span class="nv">DocSections</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nv">DocSections</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="nv">Fragments</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">split</span><span class="p">(</span>
                    <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span>
                        <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">CodeHtml</span><span class="p">,</span><span class="no">?HIGHLIGHT_START</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,[</span><span class="n">global</span><span class="p">]),</span>
                        <span class="no">?HIGHLIGHT_END</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,[</span><span class="n">global</span><span class="p">]),</span>
                    <span class="nv">Lang</span><span class="nl">#lang.divider_html</span><span class="p">,[{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="n">zipwith3</span><span class="p">(</span>
        <span class="k">fun</span><span class="p">({</span><span class="nv">DocsText</span><span class="p">,</span><span class="nv">CodeText</span><span class="p">},</span><span class="nv">DocSection</span><span class="p">,</span><span class="nv">Fragment</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="nv">DocsText</span><span class="p">,</span><span class="nv">CodeText</span><span class="p">,</span><span class="nv">DocSection</span><span class="p">,</span><span class="no">?HIGHLIGHT_START</span> <span class="o">++</span> <span class="nv">Fragment</span> <span class="o">++</span> <span class="no">?HIGHLIGHT_END</span><span class="p">}</span> <span class="k">end</span><span class="p">,</span>
        <span class="nv">Sections</span><span class="p">,</span><span class="nv">DocSections</span><span class="p">,</span><span class="nv">Fragments</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-17">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-17">&#182;</a>
  </div>
  <p>After the highlighting is done, the template is filled with documentation
and code snippets and an HTML file is written.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">generate_html</span><span class="p">(</span><span class="nv">Source</span><span class="p">,</span><span class="nv">HighlightedSections</span><span class="p">,</span><span class="nv">Jump</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="nn">filelib</span><span class="p">:</span><span class="n">ensure_dir</span><span class="p">(</span><span class="no">?OUTDIR</span><span class="p">),</span>
    <span class="nv">Filename</span> <span class="o">=</span> <span class="no">?OUTDIR</span> <span class="o">++</span> <span class="nn">filename</span><span class="p">:</span><span class="n">basename</span><span class="p">(</span><span class="nv">Source</span><span class="p">,</span><span class="nn">filename</span><span class="p">:</span><span class="n">extension</span><span class="p">(</span><span class="nv">Source</span><span class="p">))</span> <span class="o">++</span> <span class="s">&quot;.html&quot;</span><span class="p">,</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">write_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">,</span><span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span>
            <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="no">?HEADER</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">?title&quot;</span><span class="p">,</span>
                <span class="nn">filename</span><span class="p">:</span><span class="n">basename</span><span class="p">(</span><span class="nv">Source</span><span class="p">),[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
            <span class="s">&quot;</span><span class="se">\\</span><span class="s">?jump&quot;</span><span class="p">,</span><span class="nv">Jump</span><span class="p">,[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}])),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="n">mapfoldl</span><span class="p">(</span><span class="k">fun</span><span class="p">({_,_,</span><span class="nv">DocsHtml</span><span class="p">,</span><span class="nv">CodeHtml</span><span class="p">},</span><span class="nv">Index</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="nv">T</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="no">?TABLE_ENTRY</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">?index&quot;</span><span class="p">,</span><span class="nb">integer_to_list</span><span class="p">(</span><span class="nv">Index</span><span class="p">),[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                    <span class="nv">T1</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">T</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">?docs_html&quot;</span><span class="p">,</span><span class="n">replace_specials</span><span class="p">(</span><span class="nv">DocsHtml</span><span class="p">),[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                    <span class="nv">T2</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">T1</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">?code_html&quot;</span><span class="p">,</span><span class="n">replace_specials</span><span class="p">(</span><span class="nv">CodeHtml</span><span class="p">),[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                    <span class="nn">file</span><span class="p">:</span><span class="n">write_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">,</span><span class="n">restore_specials</span><span class="p">(</span><span class="nv">T2</span><span class="p">),[</span><span class="n">append</span><span class="p">]),</span>
                    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
                <span class="k">end</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="nv">HighlightedSections</span><span class="p">),</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">write_file</span><span class="p">(</span><span class="nv">Filename</span><span class="p">,</span><span class="no">?FOOTER</span><span class="p">,[</span><span class="n">append</span><span class="p">]),</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">copy</span><span class="p">(</span><span class="s">&quot;priv/erocco.css&quot;</span><span class="p">,</span><span class="no">?OUTDIR</span> <span class="o">++</span> <span class="s">&quot;erocco.css&quot;</span><span class="p">),</span>
    <span class="nv">Filename</span><span class="p">.</span></pre></div>
</td>
</tr>
<tr id="section-18">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-18">&#182;</a>
  </div>
  <h3>Helpers</h3>
</td>
<td class="code">
  <div class="highlight"><pre></pre></div>
</td>
</tr>
<tr id="section-19">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-19">&#182;</a>
  </div>
  <p>Read a source file by lines.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">read_source</span><span class="p">(</span><span class="nv">Source</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Device</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="nv">Source</span><span class="p">,</span> <span class="p">[</span><span class="n">read</span><span class="p">,</span> <span class="p">{</span><span class="n">encoding</span><span class="p">,</span> <span class="n">utf8</span><span class="p">}]),</span>
    <span class="nv">Lines</span> <span class="o">=</span> <span class="n">read_lines</span><span class="p">(</span><span class="nv">Device</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="nv">Device</span><span class="p">),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="n">reverse</span><span class="p">(</span><span class="nv">Lines</span><span class="p">).</span>

<span class="nf">read_lines</span><span class="p">(</span><span class="nv">IoDevice</span><span class="p">,</span> <span class="nv">Lines</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="n">read_line</span><span class="p">(</span><span class="nv">IoDevice</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Data</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">read_lines</span><span class="p">(</span><span class="nv">IoDevice</span><span class="p">,</span> <span class="p">[</span><span class="nv">Data</span> <span class="p">|</span> <span class="nv">Lines</span><span class="p">]);</span>
        <span class="n">eof</span> <span class="o">-&gt;</span> <span class="nv">Lines</span>
    <span class="k">end</span><span class="p">.</span> </pre></div>
</td>
</tr>
<tr id="section-20">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-20">&#182;</a>
  </div>
  <p>Save docs_html and code_html to a table of split sections.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">save_section</span><span class="p">(</span><span class="nv">DocsText</span><span class="p">,</span> <span class="nv">CodeText</span><span class="p">,</span> <span class="nv">Sections</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">[{</span><span class="nn">string</span><span class="p">:</span><span class="n">join</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="n">reverse</span><span class="p">(</span><span class="nv">DocsText</span><span class="p">),</span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="nn">string</span><span class="p">:</span><span class="n">join</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="n">reverse</span><span class="p">(</span><span class="nv">CodeText</span><span class="p">),</span><span class="s">&quot;&quot;</span><span class="p">)}</span> <span class="p">|</span> <span class="nv">Sections</span><span class="p">].</span></pre></div>
</td>
</tr>
<tr id="section-21">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-21">&#182;</a>
  </div>
  <p>Get a list of supported languages, including file extension, name,
comment symbol and etc.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">languages</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="p">[</span> <span class="nv">Lang</span><span class="nl">#lang</span><span class="p">{</span><span class="n">comment_matcher</span><span class="o">=</span><span class="s">&quot;^</span><span class="se">\\</span><span class="s">s*&quot;</span> <span class="o">++</span> <span class="nv">Lang</span><span class="nl">#lang.symbol</span> <span class="o">++</span> <span class="s">&quot;+</span><span class="se">\\</span><span class="s">s?&quot;</span><span class="p">,</span>
                <span class="n">comment_filter</span><span class="o">=</span><span class="s">&quot;(^#![/]|^</span><span class="se">\\</span><span class="s">s*#</span><span class="se">\\</span><span class="s">{)&quot;</span><span class="p">,</span>
                <span class="n">divider_text</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">++</span> <span class="nv">Lang</span><span class="nl">#lang.symbol</span> <span class="o">++</span> <span class="s">&quot;DIVIDER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                <span class="n">divider_html</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">n*&lt;span class=</span><span class="se">\&quot;</span><span class="s">c1?</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span> <span class="o">++</span> <span class="nv">Lang</span><span class="nl">#lang.symbol</span> <span class="o">++</span> <span class="s">&quot;DIVIDER&lt;</span><span class="se">\\</span><span class="s">/span&gt;</span><span class="se">\\</span><span class="s">n*&quot;</span><span class="p">}</span> 
        <span class="p">||</span> <span class="nv">Lang</span> <span class="o">&lt;-</span> <span class="no">?LANGS</span> <span class="p">].</span></pre></div>
</td>
</tr>
<tr id="section-22">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-22">&#182;</a>
  </div>
  <p>Get the language from the extenstion of a source file.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">get_language</span><span class="p">(</span><span class="nv">Source</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">get_language</span><span class="p">(</span><span class="nn">filename</span><span class="p">:</span><span class="n">extension</span><span class="p">(</span><span class="nv">Source</span><span class="p">),</span> <span class="n">languages</span><span class="p">()).</span>

<span class="nf">get_language</span><span class="p">(</span><span class="nv">Ext</span><span class="p">,</span> <span class="p">[])</span> <span class="o">-&gt;</span> 
    <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="s">&quot;File extension &quot;</span> <span class="o">++</span> <span class="nv">Ext</span> <span class="o">++</span> <span class="s">&quot; is not recognized.&quot;</span><span class="p">};</span>
<span class="nf">get_language</span><span class="p">(</span><span class="nv">Ext</span><span class="p">,</span> <span class="p">[</span><span class="nv">H</span> <span class="p">|</span> <span class="p">_])</span> <span class="k">when</span> <span class="nv">Ext</span> <span class="o">==</span> <span class="nv">H</span><span class="nl">#lang.extension</span> <span class="o">-&gt;</span>
    <span class="nv">H</span><span class="p">;</span>
<span class="nf">get_language</span><span class="p">(</span><span class="nv">Ext</span><span class="p">,</span> <span class="p">[_</span> <span class="p">|</span> <span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">get_language</span><span class="p">(</span><span class="nv">Ext</span><span class="p">,</span> <span class="nv">T</span><span class="p">).</span></pre></div>
</td>
</tr>
<tr id="section-23">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-23">&#182;</a>
  </div>
  <p>Test if Pygments is installed on the local machine.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">is_pygmentize</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">os</span><span class="p">:</span><span class="n">find_executable</span><span class="p">(</span><span class="no">?PYGMENTIZE</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">;</span>
        <span class="p">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="k">end</span><span class="p">.</span></pre></div>
</td>
</tr>
<tr id="section-24">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-24">&#182;</a>
  </div>
  <p>Use Pygments to highlight the source code. It calls the executable file
if it is installed locally. Otherwise, it invokes the web service.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">pygmentize</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Code</span><span class="p">,</span><span class="nv">ParentID</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">PygmentizeFun</span> <span class="o">=</span> <span class="k">case</span> <span class="n">is_pygmentize</span><span class="p">()</span> <span class="k">of</span>
        <span class="n">true</span> <span class="o">-&gt;</span> <span class="k">fun</span> <span class="n">pygmentize_local</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">false</span> <span class="o">-&gt;</span> 
            <span class="nn">io</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;WARNING: Pygments not found. Using webservice.&quot;</span><span class="p">),</span>
            <span class="k">fun</span> <span class="n">pygmentize_webservice</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="nv">CodeHighlighted</span> <span class="o">=</span> <span class="nv">PygmentizeFun</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Code</span><span class="p">),</span>
    <span class="nv">ParentID</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">CodeHighlighted</span><span class="p">}.</span></pre></div>
</td>
</tr>
<tr id="section-25">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-25">&#182;</a>
  </div>
  <p>Calls the Pygments executable to highlight the code. A temporary file
which only contains the source code is created as the input.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">pygmentize_local</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Code</span><span class="p">)</span> <span class="o">-&gt;</span> 
    <span class="nv">TmpFile</span> <span class="o">=</span> <span class="n">get_tmpfile</span><span class="p">(</span><span class="nv">Lang</span><span class="p">),</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">write_file</span><span class="p">(</span><span class="nv">TmpFile</span><span class="p">,</span><span class="nv">Code</span><span class="p">),</span>
    <span class="nv">Res</span> <span class="o">=</span> <span class="nn">os</span><span class="p">:</span><span class="n">cmd</span><span class="p">(</span>
            <span class="no">?PYGMENTIZE</span> <span class="o">++</span> <span class="s">&quot; -l &quot;</span> <span class="o">++</span> <span class="nv">Lang</span><span class="nl">#lang.name</span> <span class="o">++</span> 
            <span class="s">&quot; -O encoding=utf-8 -f html &quot;</span> <span class="o">++</span> <span class="nv">TmpFile</span><span class="p">),</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="nv">TmpFile</span><span class="p">),</span>
    <span class="nv">Res</span><span class="p">.</span>

<span class="nf">get_tmpfile</span><span class="p">(</span><span class="nv">Lang</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="nv">MgSecs</span><span class="p">,</span><span class="nv">Secs</span><span class="p">,</span><span class="nv">MiSecs</span><span class="p">}</span> <span class="o">=</span> <span class="n">now</span><span class="p">(),</span>
    <span class="nn">lists</span><span class="p">:</span><span class="n">flatten</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~p</span><span class="s">_</span><span class="si">~p</span><span class="s">_</span><span class="si">~p~s</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="nv">MgSecs</span><span class="p">,</span><span class="nv">Secs</span><span class="p">,</span><span class="nv">MiSecs</span><span class="p">,</span><span class="nv">Lang</span><span class="nl">#lang.extension</span><span class="p">])).</span></pre></div>
</td>
</tr>
<tr id="section-26">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-26">&#182;</a>
  </div>
  <p>Calls Pygments web service to highlight the source code. Proxy can
be specified in environment variable <em>http</em><em>_</em><em>proxy</em>.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">pygmentize_webservice</span><span class="p">(</span><span class="nv">Lang</span><span class="p">,</span><span class="nv">Code</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">inets</span><span class="p">:</span><span class="n">start</span><span class="p">(),</span>
    <span class="k">case</span> <span class="n">resolve_proxy</span><span class="p">()</span> <span class="k">of</span> 
        <span class="p">{</span><span class="nv">Host</span><span class="p">,</span><span class="nv">Port</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="nn">httpc</span><span class="p">:</span><span class="n">set_options</span><span class="p">([{</span><span class="n">proxy</span><span class="p">,</span> <span class="p">{{</span><span class="nv">Host</span><span class="p">,</span><span class="nv">Port</span><span class="p">},[]}}]);</span>
        <span class="p">_</span> <span class="o">-&gt;</span> <span class="n">ok</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">{_,_,</span><span class="nv">Body</span><span class="p">}}</span> <span class="o">=</span> <span class="nn">httpc</span><span class="p">:</span><span class="n">request</span><span class="p">(</span><span class="n">post</span><span class="p">,</span>
                        <span class="p">{</span><span class="no">?PYGMENTIZE_URL</span><span class="p">,[],</span>
                        <span class="s">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
                        <span class="s">&quot;lang=&quot;</span> <span class="o">++</span> <span class="nv">Lang</span><span class="nl">#lang.name</span> <span class="o">++</span> <span class="s">&quot;&amp;code=&quot;</span> <span class="o">++</span> <span class="n">url_encode</span><span class="p">(</span><span class="nv">Code</span><span class="p">)},</span>
                        <span class="p">[],[]),</span>
    <span class="nn">inets</span><span class="p">:</span><span class="n">stop</span><span class="p">(),</span>
    <span class="nv">Body</span><span class="p">.</span>

<span class="nf">resolve_proxy</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">os</span><span class="p">:</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;http_proxy&quot;</span><span class="p">)</span> <span class="k">of</span>
        <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">;</span>
        <span class="nv">Proxy</span> <span class="o">-&gt;</span>
            <span class="k">case</span> <span class="nn">re</span><span class="p">:</span><span class="n">split</span><span class="p">(</span><span class="nv">Proxy</span><span class="p">,</span><span class="s">&quot;//|:&quot;</span><span class="p">,[{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}])</span> <span class="k">of</span>
                <span class="p">[_,[],</span><span class="nv">Host</span><span class="p">,</span><span class="nv">Port</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Host</span><span class="p">,</span><span class="nb">list_to_integer</span><span class="p">(</span><span class="nv">Port</span><span class="p">)};</span>
                <span class="p">[_,[],</span><span class="nv">Host</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="nv">Host</span><span class="p">,</span><span class="mi">80</span><span class="p">}</span>
            <span class="k">end</span>
    <span class="k">end</span><span class="p">.</span></pre></div>
</td>
</tr>
<tr id="section-27">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-27">&#182;</a>
  </div>
  <p>URL encode the content.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">url_encode</span><span class="p">([])</span> <span class="o">-&gt;</span> <span class="p">[];</span>
<span class="nf">url_encode</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="k">when</span> <span class="nv">H</span><span class="o">==</span><span class="sc">$;</span><span class="p">;</span> <span class="nv">H</span><span class="o">==</span><span class="sc">$+</span><span class="p">;</span> <span class="nv">H</span><span class="o">==</span><span class="sc">$&amp;</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nb">integer_to_list</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">[</span><span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="sc">$%</span><span class="p">,</span> <span class="nv">X</span><span class="p">,</span> <span class="nv">Y</span> <span class="p">|</span> <span class="n">url_encode</span><span class="p">(</span><span class="nv">T</span><span class="p">)];</span>
        <span class="p">[</span><span class="nv">X</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="sc">$%</span><span class="p">,</span> <span class="sc">$0</span><span class="p">,</span> <span class="nv">X</span> <span class="p">|</span> <span class="n">url_encode</span><span class="p">(</span><span class="nv">T</span><span class="p">)]</span>
    <span class="k">end</span><span class="p">;</span>
<span class="nf">url_encode</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">T</span><span class="p">])</span> <span class="o">-&gt;</span>
    <span class="p">[</span><span class="nv">H</span> <span class="p">|</span> <span class="n">url_encode</span><span class="p">(</span><span class="nv">T</span><span class="p">)].</span></pre></div>
</td>
</tr>
<tr id="section-28">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-28">&#182;</a>
  </div>
  <p>Use Gordon Guthrie's 
<a href="http://github.com/gordonguthrie/erlmarkdown">erlmarkdown</a> to generate
the documentation.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">markdown</span><span class="p">(</span><span class="nv">Sections</span><span class="p">,</span><span class="nv">ParentID</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">DocSections</span> <span class="o">=</span> <span class="p">[</span><span class="nn">markdown</span><span class="p">:</span><span class="n">conv_utf8</span><span class="p">(</span><span class="nv">DocsText</span><span class="p">)</span> <span class="p">||</span> <span class="p">{</span><span class="nv">DocsText</span><span class="p">,_}</span> <span class="o">&lt;-</span> <span class="nv">Sections</span><span class="p">],</span>
    <span class="nv">ParentID</span> <span class="o">!</span> <span class="p">{</span><span class="n">self</span><span class="p">(),</span> <span class="nv">DocSections</span><span class="p">}.</span></pre></div>
</td>
</tr>
<tr id="section-29">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-29">&#182;</a>
  </div>
  <p>Characters &amp; and \\ are special in Erlang regular expression. Replace
and restore them with placeholders to escape them.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">replace_specials</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="no">?AMP</span><span class="p">,[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                <span class="s">&quot;</span><span class="se">\\\\</span><span class="s">&quot;</span><span class="p">,</span><span class="no">?SLASH</span><span class="p">,[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]).</span>

<span class="nf">restore_specials</span><span class="p">(</span><span class="nv">String</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="nv">String</span><span class="p">,</span><span class="no">?SLASH</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                <span class="no">?AMP</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&amp;&quot;</span><span class="p">,[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]).</span></pre></div>
</td>
</tr>
<tr id="section-30">
<td class="docs">
  <div class="pilwrap">
    <a class="pilcrow" href="#section-30">&#182;</a>
  </div>
  <p>Generate the jump section of the html documentations.</p>
</td>
<td class="code">
  <div class="highlight"><pre><span class="nf">generate_jump</span><span class="p">([],</span><span class="nv">JumpEntries</span><span class="p">,_)</span> <span class="o">-&gt;</span>
    <span class="no">?JUMP_START</span> <span class="o">++</span> <span class="nn">lists</span><span class="p">:</span><span class="n">flatten</span><span class="p">(</span><span class="nv">JumpEntries</span><span class="p">)</span> <span class="o">++</span> <span class="no">?JUMP_END</span><span class="p">;</span>
<span class="nf">generate_jump</span><span class="p">([</span><span class="nv">H</span><span class="p">|</span><span class="nv">N</span><span class="p">],</span><span class="nv">JumpEntries</span><span class="p">,</span><span class="nv">Lang</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Basename</span> <span class="o">=</span> <span class="nn">filename</span><span class="p">:</span><span class="n">basename</span><span class="p">(</span><span class="nv">H</span><span class="p">,</span><span class="nv">Lang</span><span class="nl">#lang.extension</span><span class="p">),</span>
    <span class="nv">JumpEntry</span> <span class="o">=</span> <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span>
                    <span class="nn">re</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="no">?JUMP</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">?jump_html&quot;</span><span class="p">,</span>
                        <span class="nv">Basename</span> <span class="o">++</span> <span class="s">&quot;.html&quot;</span><span class="p">,</span>
                        <span class="p">[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
                    <span class="s">&quot;</span><span class="se">\\</span><span class="s">?jump_file&quot;</span><span class="p">,</span><span class="nn">filename</span><span class="p">:</span><span class="n">basename</span><span class="p">(</span><span class="nv">H</span><span class="p">),[</span><span class="n">global</span><span class="p">,{</span><span class="n">return</span><span class="p">,</span><span class="n">list</span><span class="p">}]),</span>
    <span class="n">generate_jump</span><span class="p">(</span><span class="nv">N</span><span class="p">,[</span><span class="nv">JumpEntry</span> <span class="p">|</span> <span class="nv">JumpEntries</span><span class="p">],</span><span class="nv">Lang</span><span class="p">).</span>

</pre></div>
</td>
</tr></tbody>
    </table>
  </div>
</body>
</html>
